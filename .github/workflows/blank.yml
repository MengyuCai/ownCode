name: ÊØèÂ∞èÊó∂Ê£ÄÊü•Êñá‰ª∂ÂèòÂä®Âπ∂Ê∑ªÂä†ÂÜÖÂÆπ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: ÂÆâË£Ö jq Âíå moreutils
      run: sudo apt-get install -y jq moreutils

    - name: ‰∏ãËΩΩÂπ∂‰øÆÊîπÊñá‰ª∂
      id: modify-file
      run: |
        FILE_PATH="Clash/config/ACL4SSR_Online_Full_Netflix.ini"
        REPO="ACL4SSR/ACL4SSR"
        RAW_URL="https://raw.githubusercontent.com/${REPO}/master/${FILE_PATH}"

        # ‰∏ãËΩΩÊñá‰ª∂ÔºåÂ¢ûÂä†ÂÆπÈîôÊú∫Âà∂
        curl -s -f -o file.ini "${RAW_URL}" || { echo "Êñá‰ª∂‰∏ãËΩΩÂ§±Ë¥•"; exit 1; }

        # ËøõË°åÊñá‰ª∂‰øÆÊîπ
        awk '
        /ruleset/ && !modif1 { 
          print "ruleset=‰ª£ÁêÜËßÑÂàô,https://raw.githubusercontent.com/MengyuCai/ownCode/main/proxyCustomClashRules.list";
          modif1=1;
        }
        /ruleset/ && !modif2 {
          print "ruleset=Áõ¥ËøûËßÑÂàô,https://raw.githubusercontent.com/MengyuCai/ownCode/main/directCustomClashRules.list";
          modif2=1;
        }
        BEGIN {count1=0; count2=0}
        /custom_proxy_group/ {
          count1++;
          count2++;
          if (count1==6) {
            print "custom_proxy_group=Áõ¥ËøûËßÑÂàô`select`[]REJECT`[]DIRECT";
          }
          if (count2==7) {
            print "custom_proxy_group=‰ª£ÁêÜËßÑÂàô`select`[]üöÄ ËäÇÁÇπÈÄâÊã©`[]‚ôªÔ∏è Ëá™Âä®ÈÄâÊã©`[]üá∏üá¨ ÁãÆÂüéËäÇÁÇπ`[]üá≠üá∞ È¶ôÊ∏ØËäÇÁÇπ`[]üá®üá≥ Âè∞ÊπæËäÇÁÇπ`[]üáØüáµ Êó•Êú¨ËäÇÁÇπ`[]üá∫üá≤ ÁæéÂõΩËäÇÁÇπ`[]üá∞üá∑ Èü©ÂõΩËäÇÁÇπ`[]üöÄ ÊâãÂä®ÂàáÊç¢`[]DIRECT";
          }
        }
        /ruleset=üí¨ OpenAi/ && !modif3 {
          print "ruleset=üí¨ OpenAi,https://raw.githubusercontent.com/waltcow/chatgpt-openclash/main/chatgpt.list";
          modif3=1;
        }
        /ruleset=üé∂ ÁΩëÊòìÈü≥‰πê/ && !modif4 {
          print $0;
          print "ruleset=üé∂ ÁΩëÊòìÈü≥‰πê,https://raw.githubusercontent.com/MengyuCai/ownCode/main/NetEaseMusicRules.list";
          modif4=1;
          next;
        }
        {print}' file.ini > newfile.ini

        # ÊâìÂç∞Êñá‰ª∂ÂÜÖÂÆπÁî®‰∫éË∞ÉËØï
        cat newfile.ini

    - name: ÊØîËæÉÊñá‰ª∂
      id: compare-files
      run: |
        REPO="MengyuCai/ownCode"
        FILE_PATH="clashConfig.ini"
        RAW_URL="https://raw.githubusercontent.com/${REPO}/main/${FILE_PATH}"

        # ‰∏ãËΩΩÂΩìÂâç‰ªìÂ∫ì‰∏≠ÁöÑÊñá‰ª∂ÔºåÂ¢ûÂä†ÂÆπÈîôÊú∫Âà∂
        curl -s -f -o oldfile.ini "${RAW_URL}" || { echo "Êñá‰ª∂‰∏ãËΩΩÂ§±Ë¥•ÔºåÁªßÁª≠Êèê‰∫§Êñ∞Êñá‰ª∂"; touch oldfile.ini; }

        # ÊØîËæÉÊñá‰ª∂ÂÜÖÂÆπ
        if cmp -s newfile.ini oldfile.ini; then
          echo "changed=false" >> $GITHUB_ENV
        else
          echo "changed=true" >> $GITHUB_ENV
        fi

    - name: Êèê‰∫§Âà∞‰ªìÂ∫ì
      if: env.changed == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git clone https://${GH_TOKEN}@github.com/MengyuCai/ownCode.git
        cp newfile.ini ownCode/clashConfig.ini
        cd ownCode
        git add .
        git commit -m "Êõ¥Êñ∞ Clash ÈÖçÁΩÆÊñá‰ª∂"
        git push
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
